$=jQuery.noConflict();var obj;$.widget("custom.OpenLayer",{options:{field:null},_create:function(){$(this.element).html("");this.props=new Array("title","date","time","amount");console.log(this.options.lang);obj=this;DeleteFeature=OpenLayers.Class(OpenLayers.Control,{initialize:function(e,t){OpenLayers.Control.prototype.initialize.apply(this,[t]);this.layer=e;this.handler=new OpenLayers.Handler.Feature(this,e,{click:obj.deleteFeature})},CLASS_NAME:"OpenLayers.Control.DeleteFeature"});this.mapoptions={controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.KeyboardDefaults,new OpenLayers.Control.Zoom],displayProjection:new OpenLayers.Projection("EPSG:4326")};this.map=new OpenLayers.Map($(this.element).attr("id"),this.mapoptions);this.wgs84=new OpenLayers.Projection("EPSG:4326");this.defStyle={strokeColor:"#f54305",strokeOpacity:"0.7",strokeWidth:1,fillColor:"#f54305",pointRadius:5,cursor:"pointer"};this.sty=OpenLayers.Util.applyDefaults(this.defStyle,OpenLayers.Feature.Vector.style["default"]);this.renderer=OpenLayers.Util.getParameters(window.location.href).renderer;this.renderer=this.renderer?[this.renderer]:OpenLayers.Layer.Vector.prototype.renderers;this.vectorLayer=new OpenLayers.Layer.Vector("Vector Layer",{styleMap:new OpenLayers.StyleMap({"default":this.sty,select:{strokeColor:"#0074A4",fillColor:"#0074A4",cursor:"move",pointRadius:8}}),eventListeners:{loadend:function(e){this.map.zoomToExtent(this.getDataExtent())}},renderers:this.renderer});this.osm=new OpenLayers.Layer.OSM;this.gphy=new OpenLayers.Layer.Google("Google Physical",{type:google.maps.MapTypeId.TERRAIN});this.gmap=new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:20});this.ghyb=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20});this.gsat=new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:22});choosen_layers=new Array;for(var e in this.options.layers){choosen_layers.push(e)}available_layers=new Array(this.osm,this.gphy,this.gmap,this.ghyb,this.gsat);visible_layers=new Array;$.each(available_layers,function(e,t){if(jQuery.inArray(t.name,choosen_layers)!=-1){visible_layers.push(t)}});visible_layers.push(this.vectorLayer);this.map.addLayers(visible_layers);this.map.addControl(new OpenLayers.Control.MousePosition({id:"ll_mouse",formatOutput:this.formatLonlats}));this.map.addControl(new OpenLayers.Control.MousePosition({id:"utm_mouse",prefix:"Mercator ",displayProjection:this.map.baseLayer.projection,numDigits:0}));this.drawPoints();this.editPanel=new OpenLayers.Control.Panel({displayClass:"editPanel"});this.navControl=new OpenLayers.Control.Navigation({title:this.options.lang.Navigation});this.editControl=new OpenLayers.Control.ModifyFeature(this.vectorLayer,{dragComplete:obj.modifyFeature,title:this.options.lang.ModifyFeature});this.drawControl=new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Point,{featureAdded:this.addnewFeature,displayClass:"pointButton",title:this.options.lang.DrawFeature,handlerOptions:{style:this.sty}});this.deleteControl=new DeleteFeature(this.vectorLayer,{title:this.options.lang.DeleteFeature});this.selectfeature=new OpenLayers.Control.SelectFeature(this.vectorLayer,{clickFeature:function(e){obj.popupFeature(e)},title:this.options.lang.SelectFeature});this.switcher=new OpenLayers.Control.LayerSwitcher({title:this.options.lang.Baselayer});this.selectfeature.obj=this;this.editPanel.addControls([this.navControl,this.editControl,this.drawControl,this.deleteControl,this.selectfeature,this.switcher]);this.editPanel.defaultControl=this.editControl;this.map.addControl(this.editPanel);this.map.setCenter((new OpenLayers.LonLat(this.options.longitude,this.options.latitude)).transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject()),this.options.zoom)},drawPoints:function(){savedfeatures=$.parseJSON(this.options.features);features=new Array;$.each(savedfeatures[0],function(e,t){point=(new OpenLayers.Geometry.Point(t.lon,t.lat)).transform(new OpenLayers.Projection("EPSG:4326"),obj.map.getProjectionObject());f=new OpenLayers.Feature.Vector(point,{title:t.title,date:t.date,time:t.time,amount:t.amount});f.lonlat=(new OpenLayers.LonLat(t.lon,t.lat)).transform(new OpenLayers.Projection("EPSG:4326"),obj.map.getProjectionObject());features.push(f)});this.vectorLayer.addFeatures(features);this.updateFeatureInfo()},modifyFeature:function(e){console.log(e);$.each(obj.vectorLayer.features,function(t,n){if(e.id==n.id){lonlat=new OpenLayers.LonLat(e.geometry.x,e.geometry.y)}});obj.updateFeatureInfo()},addnewFeature:function(e){for(var t=0;t<obj.props.length;t++){e.attributes[obj.props[t]]=""}e.lonlat=new OpenLayers.LonLat(e.geometry.x,e.geometry.y);obj.updateFeatureInfo()},deleteFeature:function(e){if(e.fid==undefined){e.state=OpenLayers.State.DELETE;obj.vectorLayer.destroyFeatures([e])}else{e.state=OpenLayers.State.DELETE;obj.vectorLayer.events.triggerEvent("afterfeaturemodified",{feature:e});e.renderIntent="select";obj.vectorLayer.drawFeature(e)}obj.updateFeatureInfo();console.log(e)},updateFeatureInfo:function(e){features={};$.each(this.vectorLayer.features,function(e,t){lonlat=(new OpenLayers.LonLat(t.lonlat.lon,t.lonlat.lat)).transform(obj.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));f=t.attributes;f.lon=lonlat.lon;f.lat=lonlat.lat;features[t.id]=f});$("#"+obj.options.input).val(JSON.stringify(features))},popupFeature:function(e){e.fid=e.fid==null?10:e.fid;hasprops=Object.keys(e.attributes).length>0?1:0;selFeature=e;title=this.options.lang.properties;mform="<form class='propertyform' id='form_"+e.fid+"'>";for(var t=0;t<this.props.length;t++){an=this.props[t]=="amount"?"an":"a";ititle=obj.capitaliseFirstLetter(this.props[t]);v=e.attributes[this.props[t]]!=undefined?e.attributes[this.props[t]]:"";mform+="<div class='property'><label for='"+e.attributes[this.props[t]]+"'>"+ititle+":</label>";mform+="<input type='text' name='"+this.props[t]+"' class='"+this.props[t]+"' rel='"+e.fid+"' placeholder='type "+an+" "+this.props[t]+"' value='"+v+"'/></div>"}mform+="<div class='property'><input type='submit' value='save' class='button button-primary button-large submit'></div></form>";popup=new OpenLayers.Popup.FramedCloud("featurePopup",e.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(100,100),"<h2>"+title+"</h2>"+mform,null,true,this.onPopupClose);e.popup=popup;popup.feature=e;this.map.addPopup(popup,true);$("#form_"+e.fid).find(".submit").click(function(){$("#form_"+e.fid+" input[type=text]").each(function(t){e.attributes[$(this).attr("name")]=$(this).val()});$("#featurePopup_contentDiv").html("<div class='popupmessage'>"+this.options.lang.properties_mod+"</div>");setTimeout(function(){popup.destroy();console.log(obj);obj.updateFeatureInfo()},2500);return false})},capitaliseFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},formatLonlats:function(e){var t=e.lat;var n=e.lon;var r=OpenLayers.Util.getFormattedLonLat(t);var i=OpenLayers.Util.getFormattedLonLat(n,"lon");return r+", "+i+" ("+Math.round(t*1e4)/1e4+", "+Math.round(n*1e4)/1e4+")"}});$(document).ready(function(){$("#map").OpenLayer({field:"plekken"})})